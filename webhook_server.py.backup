#!/usr/bin/env python3
"""
Webhook Server com Envio de Email
Servidor Flask que recebe webhooks e envia notifica√ß√µes por email
Permite especificar o email de destino no payload do webhook
"""

import os
import json
import logging
import re
from datetime import datetime
from flask import Flask, request, jsonify
from flask_mail import Mail, Message
from dotenv import load_dotenv

# Carregar vari√°veis de ambiente
load_dotenv()

# Configurar logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Inicializar Flask
app = Flask(__name__)

# Configura√ß√£o de Email
app.config.update(
    # Servidor SMTP do Gmail
    MAIL_SERVER = os.getenv('MAIL_SERVER', 'smtp.gmail.com'),
    MAIL_PORT = int(os.getenv('MAIL_PORT', 587)),
    MAIL_USE_TLS = os.getenv('MAIL_USE_TLS', 'true').lower() == 'true',
    MAIL_USE_SSL = os.getenv('MAIL_USE_SSL', 'false').lower() == 'true',
    
    # Credenciais
    MAIL_USERNAME = os.getenv('MAIL_USERNAME'),
    MAIL_PASSWORD = os.getenv('MAIL_PASSWORD'),
    
    # Remetente padr√£o
    MAIL_DEFAULT_SENDER = os.getenv('MAIL_DEFAULT_SENDER')
)

# Inicializar Flask-Mail
mail = Mail(app)

# Email destinat√°rio padr√£o (usado se n√£o for especificado no webhook)
DEFAULT_RECIPIENT = os.getenv('DEFAULT_RECIPIENT_EMAIL', 'cazouvilela@gmail.com')

# Token de seguran√ßa (opcional mas recomendado)
WEBHOOK_SECRET = os.getenv('WEBHOOK_SECRET', 'webhook-cazou-2024-secret-token')

def validate_email(email):
    """Valida formato de email"""
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(pattern, email) is not None

def extract_emails_from_data(data):
    """
    Extrai emails do payload do webhook
    Procura por campos como: email, emails, destinatario, recipient, to
    """
    emails = []
    
    # Se data for string, tentar converter para dict
    if isinstance(data, str):
        try:
            data = json.loads(data)
        except:
            return emails
    
    # Se n√£o for dict, retornar lista vazia
    if not isinstance(data, dict):
        return emails
    
    # Campos poss√≠veis para emails
    email_fields = [
        'email', 'emails', 'destinatario', 'destinatarios',
        'recipient', 'recipients', 'to', 'para', 'dest'
    ]
    
    for field in email_fields:
        if field in data:
            value = data[field]
            # Se for string, adicionar √† lista
            if isinstance(value, str) and validate_email(value):
                emails.append(value)
            # Se for lista, adicionar todos os emails v√°lidos
            elif isinstance(value, list):
                for email in value:
                    if isinstance(email, str) and validate_email(email):
                        emails.append(email)
    
    return emails

@app.route('/')
def home():
    """Endpoint raiz para verificar se o servidor est√° funcionando"""
    return jsonify({
        'status': 'online',
        'message': 'Webhook server est√° rodando',
        'timestamp': datetime.now().isoformat(),
        'endpoints': {
            '/': 'Status do servidor',
            '/webhook': 'Endpoint principal (POST)',
            '/webhook/<action>': 'Webhook com a√ß√£o espec√≠fica (POST)',
            '/test-email': 'Testar envio de email (GET)',
            '/help': 'Documenta√ß√£o de uso (GET)'
        }
    })

@app.route('/help')
def help():
    """Endpoint de ajuda com documenta√ß√£o"""
    return jsonify({
        'description': 'Webhook Server com Envio de Email',
        'usage': {
            'basic': {
                'url': '/webhook',
                'method': 'POST',
                'headers': {
                    'Content-Type': 'application/json',
                    'X-Webhook-Secret': 'seu-token-secreto'
                },
                'body': {
                    'email': 'destino@example.com',
                    'data': 'seus dados aqui'
                }
            },
            'with_action': {
                'url': '/webhook/<action>',
                'method': 'POST',
                'description': 'Substitua <action> pela a√ß√£o desejada'
            },
            'multiple_recipients': {
                'body': {
                    'emails': ['email1@example.com', 'email2@example.com'],
                    'data': 'seus dados aqui'
                }
            }
        },
        'email_fields': [
            'email', 'emails', 'destinatario', 'destinatarios',
            'recipient', 'recipients', 'to', 'para', 'dest'
        ],
        'examples': {
            'single_email': {
                'email': 'usuario@gmail.com',
                'evento': 'login',
                'usuario': 'Jo√£o'
            },
            'multiple_emails': {
                'emails': ['admin@empresa.com', 'suporte@empresa.com'],
                'alerta': 'Sistema fora do ar',
                'severidade': 'critica'
            }
        }
    })

@app.route('/webhook', methods=['POST'])
def webhook():
    """Endpoint principal do webhook"""
    try:
        # Verificar token de seguran√ßa (se configurado)
        if WEBHOOK_SECRET:
            token = request.headers.get('X-Webhook-Secret')
            if token != WEBHOOK_SECRET:
                logger.warning('Tentativa de acesso n√£o autorizada')
                return jsonify({'error': 'N√£o autorizado'}), 401
        
        # Obter dados do webhook
        data = request.get_json(force=True)
        
        # Log da requisi√ß√£o recebida
        logger.info(f'Webhook recebido: {json.dumps(data, indent=2)}')
        
        # Extrair emails de destino do payload
        recipient_emails = extract_emails_from_data(data)
        
        # Se n√£o houver emails no payload, usar o padr√£o
        if not recipient_emails:
            recipient_emails = [DEFAULT_RECIPIENT]
            logger.info(f'Nenhum email encontrado no payload, usando padr√£o: {DEFAULT_RECIPIENT}')
        else:
            logger.info(f'Emails encontrados no payload: {recipient_emails}')
        
        # Preparar informa√ß√µes para o email
        webhook_info = {
            'timestamp': datetime.now().strftime('%d/%m/%Y %H:%M:%S'),
            'ip_origem': request.remote_addr,
            'headers': dict(request.headers),
            'dados': data,
            'destinatarios': recipient_emails
        }
        
        # Enviar email
        success_count = send_notification_email(webhook_info, recipient_emails)
        
        return jsonify({
            'status': 'success',
            'message': f'Webhook processado e email enviado para {success_count} destinat√°rio(s)',
            'recipients': recipient_emails
        }), 200
        
    except Exception as e:
        logger.error(f'Erro ao processar webhook: {str(e)}')
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

@app.route('/webhook/<string:action>', methods=['POST'])
def webhook_with_action(action):
    """Endpoint do webhook com a√ß√£o espec√≠fica"""
    try:
        # Verificar token de seguran√ßa
        if WEBHOOK_SECRET:
            token = request.headers.get('X-Webhook-Secret')
            if token != WEBHOOK_SECRET:
                return jsonify({'error': 'N√£o autorizado'}), 401
        
        # Obter dados
        data = request.get_json(force=True)
        
        # Log da a√ß√£o
        logger.info(f'Webhook com a√ß√£o "{action}" recebido')
        
        # Extrair emails de destino
        recipient_emails = extract_emails_from_data(data)
        if not recipient_emails:
            recipient_emails = [DEFAULT_RECIPIENT]
        
        # Preparar informa√ß√µes
        webhook_info = {
            'acao': action,
            'timestamp': datetime.now().strftime('%d/%m/%Y %H:%M:%S'),
            'ip_origem': request.remote_addr,
            'dados': data,
            'destinatarios': recipient_emails
        }
        
        # Enviar email com a a√ß√£o no assunto
        success_count = send_notification_email(webhook_info, recipient_emails, action=action)
        
        return jsonify({
            'status': 'success',
            'action': action,
            'message': f'Webhook {action} processado para {success_count} destinat√°rio(s)',
            'recipients': recipient_emails
        }), 200
        
    except Exception as e:
        logger.error(f'Erro ao processar webhook {action}: {str(e)}')
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

def send_notification_email(webhook_info, recipient_emails, action=None):
    """
    Fun√ß√£o para enviar email de notifica√ß√£o
    Retorna o n√∫mero de emails enviados com sucesso
    """
    success_count = 0
    
    # Remover campos sens√≠veis dos dados antes de enviar
    dados_limpos = webhook_info.get('dados', {}).copy()
    for campo_email in ['email', 'emails', 'destinatario', 'destinatarios', 
                        'recipient', 'recipients', 'to', 'para', 'dest']:
        dados_limpos.pop(campo_email, None)
    
    try:
        # Preparar assunto
        if action:
            subject = f'[Webhook] A√ß√£o: {action} - {webhook_info["timestamp"]}'
        else:
            subject = f'[Webhook] Notifica√ß√£o - {webhook_info["timestamp"]}'
        
        # Preparar corpo do email
        body = f"""
        <html>
        <body style="font-family: Arial, sans-serif;">
            <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px;">
                    üîî Notifica√ß√£o de Webhook
                </h2>
                
                <div style="background-color: #f9f9f9; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <h3 style="color: #555;">üìä Informa√ß√µes Gerais</h3>
                    <ul style="list-style-type: none; padding-left: 0;">
                        <li><strong>üìÖ Data/Hora:</strong> {webhook_info.get('timestamp')}</li>
                        <li><strong>üåê IP de Origem:</strong> {webhook_info.get('ip_origem')}</li>
                        {f'<li><strong>‚ö° A√ß√£o:</strong> <span style="color: #4CAF50; font-weight: bold;">{webhook_info.get("acao")}</span></li>' if webhook_info.get('acao') else ''}
                        <li><strong>üìß Enviado para:</strong> {', '.join(webhook_info.get('destinatarios', []))}</li>
                    </ul>
                </div>
                
                <div style="background-color: #f0f8ff; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <h3 style="color: #555;">üì¶ Dados Recebidos</h3>
                    <pre style="background-color: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 3px; overflow-x: auto;">
{json.dumps(dados_limpos, indent=2, ensure_ascii=False)}
                    </pre>
                </div>
                
                <details style="margin: 15px 0;">
                    <summary style="cursor: pointer; color: #4CAF50; font-weight: bold;">
                        üîß Headers da Requisi√ß√£o (clique para expandir)
                    </summary>
                    <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 3px; margin-top: 10px; font-size: 12px;">
{json.dumps(webhook_info.get('headers', {}), indent=2, ensure_ascii=False)}
                    </pre>
                </details>
                
                <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">
                
                <p style="color: #888; font-size: 12px; text-align: center;">
                    Este √© um email autom√°tico enviado pelo Webhook Server.<br>
                    Configurado por: cazouvilela@gmail.com
                </p>
            </div>
        </body>
        </html>
        """
        
        # Criar mensagem
        msg = Message(
            subject=subject,
            recipients=recipient_emails,
            html=body
        )
        
        # Adicionar vers√£o em texto simples
        msg.body = f"""
        Notifica√ß√£o de Webhook
        
        Data/Hora: {webhook_info.get('timestamp')}
        IP de Origem: {webhook_info.get('ip_origem')}
        {'A√ß√£o: ' + webhook_info.get('acao') if webhook_info.get('acao') else ''}
        Enviado para: {', '.join(webhook_info.get('destinatarios', []))}
        
        Dados Recebidos:
        {json.dumps(dados_limpos, indent=2, ensure_ascii=False)}
        """
        
        # Enviar email
        mail.send(msg)
        success_count = len(recipient_emails)
        logger.info(f'Email enviado com sucesso para {success_count} destinat√°rio(s): {", ".join(recipient_emails)}')
        
    except Exception as e:
        logger.error(f'Erro ao enviar email: {str(e)}')
        raise
    
    return success_count

@app.route('/test-email', methods=['GET', 'POST'])
def test_email():
    """Endpoint para testar o envio de email"""
    try:
        # Permitir especificar email de teste via query param ou JSON
        test_email_address = None
        
        # Verificar query parameter
        test_email_address = request.args.get('email')
        
        # Se for POST, verificar o body
        if request.method == 'POST':
            data = request.get_json(silent=True)
            if data and 'email' in data:
                test_email_address = data['email']
        
        # Validar email se fornecido
        if test_email_address and not validate_email(test_email_address):
            return jsonify({
                'status': 'error',
                'message': f'Email inv√°lido: {test_email_address}'
            }), 400
        
        # Usar email padr√£o se n√£o fornecido
        if not test_email_address:
            test_email_address = DEFAULT_RECIPIENT
        
        msg = Message(
            subject='‚úÖ Teste de Email - Webhook Server',
            recipients=[test_email_address],
            html="""
            <html>
            <body style="font-family: Arial, sans-serif;">
                <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                    <h2 style="color: #4CAF50;">‚úÖ Teste Bem-Sucedido!</h2>
                    <p>Este √© um email de teste do seu webhook server.</p>
                    <p>Se voc√™ recebeu este email, a configura√ß√£o est√° correta!</p>
                    <hr style="border: none; border-top: 1px solid #ddd;">
                    <h3>Informa√ß√µes da Configura√ß√£o:</h3>
                    <ul>
                        <li><strong>Servidor SMTP:</strong> smtp.gmail.com</li>
                        <li><strong>Remetente:</strong> cazouvilela@gmail.com</li>
                        <li><strong>Timestamp:</strong> {timestamp}</li>
                    </ul>
                    <p style="color: #888; font-size: 12px;">
                        Webhook Server configurado e funcionando corretamente!
                    </p>
                </div>
            </body>
            </html>
            """.format(timestamp=datetime.now().strftime('%d/%m/%Y %H:%M:%S')),
            body=f"""
            Teste de Email - Webhook Server
            
            Este √© um email de teste do seu webhook server.
            Se voc√™ recebeu este email, a configura√ß√£o est√° correta!
            
            Servidor SMTP: smtp.gmail.com
            Remetente: cazouvilela@gmail.com
            Timestamp: {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}
            """
        )
        mail.send(msg)
        
        return jsonify({
            'status': 'success',
            'message': f'Email de teste enviado para {test_email_address}',
            'timestamp': datetime.now().isoformat()
        }), 200
        
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 500

if __name__ == '__main__':
    # Verificar configura√ß√µes essenciais
    if not app.config['MAIL_USERNAME'] or not app.config['MAIL_PASSWORD']:
        logger.error('MAIL_USERNAME e MAIL_PASSWORD devem ser configurados!')
        logger.error('Verifique o arquivo .env')
        exit(1)
    
    # Mostrar configura√ß√£o atual (sem mostrar a senha)
    logger.info('=== Configura√ß√£o do Webhook Server ===')
    logger.info(f'Email remetente: {app.config["MAIL_USERNAME"]}')
    logger.info(f'Servidor SMTP: {app.config["MAIL_SERVER"]}:{app.config["MAIL_PORT"]}')
    logger.info(f'Email padr√£o para notifica√ß√µes: {DEFAULT_RECIPIENT}')
    logger.info(f'Token de seguran√ßa configurado: {"Sim" if WEBHOOK_SECRET else "N√£o"}')
    logger.info('=====================================')
    
    # Iniciar servidor
    logger.info('Iniciando webhook server na porta 5000...')
    logger.info('Acesse http://localhost:5000 para verificar o status')
    logger.info('Use http://localhost:5000/help para ver a documenta√ß√£o')
    
    # Para produ√ß√£o, use um servidor WSGI como Gunicorn
    # Para desenvolvimento/teste
    app.run(
        host='0.0.0.0',  # Escutar em todas as interfaces
        port=5000,        # Porta do webhook
        debug=False       # Mudar para True para desenvolvimento
    )
